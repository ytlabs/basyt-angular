angular.module("basyt.angular",["ui.router"]).config(["$httpProvider",function(a){a.interceptors.push("AuthInterceptor")}]).value("BasytAnonState","login").value("BasytAuthMessages",{loginRequired:"Login Required",loginSuccess:"Login Successful",loginFailed:"Login Failed",logoutSuccess:"Logout Successful",authFailed:"Authorization Failed"}).run(["$rootScope","Auth","$state","BasytAnonState","$injector","BasytAuthMessages",function(a,b,c,d,e,f){var g=e.get("$alert");a.$on("$stateChangeStart",function(a,e){e.role&&(b.isAuthenticated(e.role)||(g&&g({title:f.loginRequired,type:"danger",duration:6}),c.go(d),a.preventDefault()))}),a.$on("user:anonymous",function(){angular.isDefined(c.current.role)&&"ANON"!==c.current.role&&g&&g({title:f.loginRequired,type:"danger",duration:6}),c.go(d)})}]),angular.module("basyt.angular").factory("Auth",["BasytLocalStore","Request","$q","$rootScope","$injector","BasytAuthMessages",function(a,b,c,d,e,f){var g={user_state:"ANON"},h=g,i=e.get("$alert"),j=function(b){return a.set("auth_token",b.result.token),delete b.result.token,a.set("auth_user",JSON.stringify(b.result)),h=b.result,d.activeUser=h,d.activeUser.user_state=m.isLord()?"LORD":m.isAdmin()?"ADMIN":"USER",i&&i({title:f.loginSuccess,type:"info",duration:3}),d.$broadcast("user:login",b.result),h},k=function(b){a.unset("auth_token"),a.unset("auth_user"),h=g,d.activeUser=h,!b&&i&&i({title:f.logoutSuccess,type:"info",duration:3}),d.$broadcast("user:logout")},l=function(a){var b=c.defer();return k(!0),b.reject(a),i&&i({title:f.loginFailed,type:"danger",duration:6}),b.promise},m={authorize:function(a){return a?this.isAuthenticated(a):!0},isAuthenticated:function(b,c){if(a.get("auth_token")){if(c&&m.authenticate(),angular.isUndefined(h.id)){var e=a.get("auth_user");if(!e)return!1;if(h=angular.fromJson(e),angular.isUndefined(h.id))return!1;d.activeUser=h,i&&i({title:f.loginSuccess,type:"info",duration:3}),d.activeUser.user_state=m.isLord()?"LORD":m.isAdmin()?"ADMIN":"USER"}return"USER"!=b?angular.isUndefined(h.id)?!1:angular.isDefined(h.roles)?h.roles.indexOf(b)>-1:!1:!0}return!1},getUser:function(){return h},isLord:function(){return angular.isDefined(h.roles)?h.roles.indexOf("LORD")>-1:!1},isAdmin:function(){return angular.isDefined(h.roles)?h.roles.indexOf("ADMIN")>-1||h.roles.indexOf("LORD")>-1:!1},login:function(a,c){return k(!0),b("user:login",{data:a}).then(j,l)},logout:k,register:function(a){return k(!0),b("user:register",{user:a}).then(j,l)},authenticate:function(){return b("user:authorize").then(function(){},k)}};return m}]),angular.module("basyt.angular").factory("AuthInterceptor",["$q","BasytLocalStore","$rootScope",function(a,b,c){return{request:function(a){var c;return b.get("auth_token")&&(c=b.get("auth_token")),c&&(a.headers.Authorization="Bearer "+c),a},responseError:function(d){return(401===d.status||403===d.status)&&(b.unset("auth_token"),b.unset("auth_user"),c.$broadcast("user:anonymous")),a.reject(d)}}}]),angular.module("basyt.angular").service("DataSource",["Request","$rootScope","filterFilter","Socket","$q",function(a,b,c,d,e){var f=function(a,b){var c=this;this.endpoint=a+":list",this.socketChannel="entity:"+a,this.map=b,this.isLoaded=!1,this.listeners=[],this.value=[],d.on("entity:update:"+a,function(a){c.reload(!1)}),this.reload(!0)};return f.prototype.bind=function(){var a=e.defer(),b=this,d=a.promise;return this.listeners.push(a),d.list=this.value,d.item=function(a){var d=c(b.value,{id:a});return angular.isArray(d)?d[0]:null},d.unbind=function(){a.resolve(!0),b.listeners.splice(b.listeners.indexOf(a),1)},d.listen=function(b){return a.promise.then(function(){},function(){},b)},d},f.prototype.reload=function(b){var c=this;a(this.endpoint,{params:{deep:!0}}).then(function(a){c.map&&angular.forEach(a.result,c.map),c.value=a.result,c.isLoaded=!0,angular.forEach(c.listeners,function(a){a.notify(c.value)}),b&&d.subscribe(c.socketChannel)},function(){c.value=[],c.isLoaded=!0})},f}]),angular.module("basyt.angular").factory("BasytLocalStore",function(){return{get:function(a){return localStorage.getItem(a)},set:function(a,b){return localStorage.setItem(a,b)},unset:function(a){return localStorage.removeItem(a)}}}),angular.module("basyt.angular").constant("BasytServer",{host:window.API_URL,socket:window.SOCKET_URL,socketOptions:window.SOCKET_OPTS}).factory("Request",["$http","BasytServer","$q","$rootScope","$urlMatcherFactory",function(a,b,c,d,e){var f,g,h=!1,i=c.defer();return a.get(b.host).then(function(a){return f=a.data.routes,h=!0,d.$broadcast("basyt:request:ready"),i.resolve(f),f},function(a,b){i.reject(!1)}),g=i.promise,function(d,h){return g.then(function(g){if(f.hasOwnProperty(d)){var i=angular.copy(h)||{};i.hasOwnProperty("urlParams")?(i.url=b.host+e.compile(f[d].path).format(i.urlParams),delete i.urlParams):i.url=b.host+f[d].path;var j=angular.extend({},f[d],i);return a(j).error(function(a){var b=c.defer();return a.data?b.reject(a.data.err):b.reject(!1),b.promise}).then(function(a){var b=c.defer();return a.data&&a.data.success?b.resolve(a.data):b.reject(a.data?a.data.err:!1),b.promise})}return null},function(){return null})}}]),angular.module("basyt.angular").factory("Socket",["BasytServer","BasytLocalStore","$rootScope","$q","Auth",function(a,b,c,d){var e,f=d.defer();return connect=function(){e=io.connect(a.socket,a.socketOptions),e.on("authenticated",function(){f.resolve(!0),c.$broadcast("basyt:socket:ready")}).emit("authenticate",{token:b.get("auth_token")})},connect(),{on:function(a,b){e&&e.on(a,b),f.promise.then(function(){e.on(a,b)})},off:function(a,b){e&&e.removeAllListeners(a,b)},subscribe:function(a,b){e.emit("subscribe",{resource:a,data:b})},unsubscribe:function(a,b){e.emit("unsubscribe",{resource:a,data:b})},emit:function(a,b){e.emit(a,b)},connect:connect}}]),angular.module("basyt.angular").factory("UserSettings",["Request","$rootScope",function(a,b){var c,d=!1,e={isReady:function(){return d},getSettings:function(){return d?c:{}},reload:function(){a("user_settings:get").then(function(a){c=a.result||{},d=!0,b.$broadcast("user:registered")},function(){b.$broadcast("user:anonymous")})}};return e.reload(),e}]);