angular.module("basyt.angular",["ui.router"]).config(["$httpProvider",function(a){a.interceptors.push("AuthInterceptor")}]),angular.module("basyt.angular").factory("Auth",["LocalStore","AccessLevels","Request","$q","$rootScope",function(a,b,c,d,e){var f,g=function(b){return a.set("auth_token",b.result.token),delete b.result.token,a.set("auth_user",JSON.stringify(b.result)),e.$broadcast("user:login",b.result),f=b.result,e.activeUser=f,f},h=function(){a.unset("auth_token"),a.unset("auth_user"),e.$broadcast("user:logout"),f=null,e.activeUser=f},i=function(a){var b=d.defer();return h(),b.reject(a),b.promise},j={authorize:function(a){return a?this.isAuthenticated(a):!0},isAuthenticated:function(b,c){if(a.get("auth_token")){if(c&&j.authenticate(),!f){var d=a.get("auth_user");d&&(f=angular.fromJson(d),e.activeUser=f)}return"USER"!=b?f&&angular.isDefined(f.roles)?f.roles.indexOf(b)>-1:!1:!0}return!1},getUser:function(){return f},isLord:function(){return angular.isDefined(f)&&angular.isDefined(f.roles)?f.roles.indexOf("LORD")>-1:!1},isAdmin:function(){return angular.isDefined(f)&&angular.isDefined(f.roles)?f.roles.indexOf("ADMIN")>-1||f.roles.indexOf("LORD")>-1:!1},login:function(a){return h(),c("user:login",{data:a}).then(g,i)},logout:h,register:function(a){return h(),c("user:register",{user:a}).then(g,i)},authenticate:function(){return c("user:authorize").then(function(){},h)}};return j}]),angular.module("basyt.angular").factory("AuthInterceptor",["$q","$injector",function(a,b){var c=b.get("LocalStore");return{request:function(a){var b;return c.get("auth_token")&&(b=c.get("auth_token")),b&&(a.headers.Authorization="Bearer "+b),a},responseError:function(b){return 401===b.status||403===b.status,a.reject(b)}}}]),angular.module("basyt.angular").service("DataSource",["Request","$rootScope","filterFilter","Socket","$q",function(a,b,c,d,e){var f=function(a,b){var c=this;this.endpoint=a+":list",this.socketChannel="entity:"+a,this.map=b,this.isLoaded=!1,this.listeners=[],this.value=[],d.on("entity:update:"+a,function(){c.reload(!1)}),this.reload(!0)};return f.prototype.bind=function(){var a=e.defer(),b=this,d=a.promise;return this.listeners.push(a),d.list=this.value,d.item=function(a){var d=c(b.value,{id:a});return angular.isArray(d)?d[0]:null},d.unbind=function(){a.resolve(!0),b.listeners.splice(b.listeners.indexOf(a),1)},d.listen=function(b){return a.promise.then(function(){},function(){},b)},d},f.prototype.reload=function(b){var c=this;a(this.endpoint,{params:{deep:!0}}).then(function(a){c.map&&angular.forEach(a.result,c.map),c.value=a.result,c.isLoaded=!0,angular.forEach(c.listeners,function(a){a.notify(c.value)}),b&&d.subscribe(c.socketChannel)},function(){c.value=[],c.isLoaded=!0})},f}]),angular.module("basyt.angular").constant("BasytServer",{host:window.API_URL,socket:window.SOCKET_URL,socketOptions:window.SOCKET_OPTS}).factory("Request",["$http","BasytServer","$q","$rootScope","$urlMatcherFactory",function(a,b,c,d,e){var f,g,h=!1,i=c.defer();return a.get(b.host).then(function(a){return f=a.data.routes,h=!0,d.$broadcast("basyt:request:ready"),i.resolve(f),f},function(){i.reject(!1)}),g=i.promise,function(d,h){return g.then(function(){if(f.hasOwnProperty(d)){var g=angular.copy(h)||{};g.hasOwnProperty("urlParams")?(g.url=b.host+e.compile(f[d].path).format(g.urlParams),delete g.urlParams):g.url=b.host+f[d].path;var i=angular.extend({},f[d],g);return a(i).error(function(a){var b=c.defer();return b.reject(a.data?a.data.err:!1),b.promise}).then(function(a){var b=c.defer();return a.data&&a.data.success?b.resolve(a.data):b.reject(a.data?a.data.err:!1),b.promise})}return null},function(){return null})}}]),angular.module("basyt.angular").factory("Socket",["BasytServer","LocalStore","$rootScope","$q","Auth",function(a,b,c,d){var e,f=d.defer();return connect=function(){e=io.connect(a.socket,a.socketOptions),e.on("authenticated",function(){f.resolve(!0),c.$broadcast("basyt:socket:ready")}).emit("authenticate",{token:b.get("auth_token")})},connect(),{on:function(a,b){e&&e.on(a,b),f.promise.then(function(){e.on(a,b)})},subscribe:function(a,b){e.emit("subscribe",{resource:a,company_id:b})},unsubscribe:function(a,b){e.emit("unsubscribe",{resource:a,company_id:b})},connect:connect}}]),angular.module("basyt.angular").factory("UserSettings",["Request","$rootScope",function(a,b){var c,d=!1,e={isReady:function(){return d},getSettings:function(){return d?c:{}},reload:function(){a("user_settings:get").then(function(a){c=a.result||{},d=!0,b.$broadcast("entity:user_settings")})}};return e.reload(),e}]);